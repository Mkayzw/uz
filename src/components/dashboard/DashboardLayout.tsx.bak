'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import DashboardSidebar from '@/components/dashboard/DashboardSidebar'
import DashboardHeader from '@/components/dashboard/DashboardHeader'
import DashboardOverview from '@/components/dashboard/DashboardOverview'
import PropertiesBrowser from '@/components/dashboard/PropertiesBrowser'
import AgentProperties from '@/components/dashboard/AgentProperties'
import DashboardApplications from '@/components/dashboard/DashboardApplications'
import SavedProperties from '@/components/dashboard/SavedProperties'
import DashboardAccount from '@/components/dashboard/DashboardAccount'
import CommissionTracking from '@/components/dashboard/CommissionTracking'
import ConfirmationModal from '@/components/ConfirmationModal'
import NotificationModal from '@/components/NotificationModal'
import ToastManager from '@/components/ToastManager'
import ImageModal from '@/components/ImageModal'
import ApplicationModal from '@/components/ApplicationModal'
import { useDashboardAuth } from '@/hooks/useDashboardAuth'
import { useDashboardData } from '@/hooks/useDashboardData'
import { useRealTimeSubscriptions } from '@/hooks/useRealTimeSubscriptions'
import { useNavigationState } from '@/hooks/useNavigationState'
import { useSupabaseClient } from '@/hooks/useSupabaseClient'
import { updateApplicationStatus, verifyPayment, cancelApplication, submitApplication } from '@/app/dashboard/actions'
import { 
  DashboardTab, 
  NotificationModal as NotificationModalType, 
  ConfirmationModal as ConfirmationModalType, 
  ImageModal as ImageModalType, 
  ApplicationModal as ApplicationModalType,
  Bed
} from '@/types/dashboard'
import { BellIcon } from '@heroicons/react/24/outline'

export default function DashboardLayout() {
  const supabase = useSupabaseClient()
  const router = useRouter()
  const searchParams = useSearchParams()
  
  // Use custom hooks for state management
  const { user, profile, loading: authLoading, error: authError, displayName, handleSignOut } = useDashboardAuth()
  const { navigateWithHistory, isBackNavigation } = useNavigationState()
  const {
    properties,
    allProperties,
    applications,
    agentApplications,
    savedProperties,
    loading: dataLoading,
    error: dataError,
    refreshData,
    setProperties,
    setAllProperties,
    setApplications,
    setAgentApplications,
    setSavedProperties
  } = useDashboardData({ user, profile })

  // Set up real-time subscriptions
  useRealTimeSubscriptions({
    user,
    profile,
    setProfile: () => {}, // Profile updates handled by auth hook
    setProperties,
    setAllProperties,
    setApplications,
    setAgentApplications,
    setSavedProperties
  })

  // Local state for UI
  const [activeTab, setActiveTab] = useState<DashboardTab>((searchParams.get('tab') as DashboardTab) || 'browse')
  const [applicationModal, setApplicationModal] = useState<ApplicationModalType>({
    isOpen: false,
    bedId: null
  })
  const [availableBeds, setAvailableBeds] = useState<any[]>([])

  // Modal states
  const [confirmationModal, setConfirmationModal] = useState<ConfirmationModalType>({
    isOpen: false,
    title: '',
    message: '',
    onConfirm: () => {},
  })

  const [notificationModal, setNotificationModal] = useState<NotificationModalType>({
    isOpen: false,
    title: '',
    message: '',
    type: 'info',
  })

  const [imageModal, setImageModal] = useState<ImageModalType>({
    isOpen: false,
    src: '',
    alt: '',
  })

  // Mock data for badges - replace with real data from your hooks
  const pendingApplicationsCount = profile?.role === 'agent' ? 5 : 2

  // Set default tab based on user role
  useEffect(() => {
    if (profile && !searchParams.get('tab')) {
      const defaultTab = profile.role === 'agent' ? 'properties' : 'browse'
      setActiveTab(defaultTab)
    }
  }, [profile, searchParams])

  // Helper functions for modals
  const showConfirmation = (config: Omit<ConfirmationModalType, 'isOpen'>) => {
    setConfirmationModal({ ...config, isOpen: true })
  }

  const hideConfirmation = () => {
    setConfirmationModal(prev => ({ ...prev, isOpen: false }))
  }

  const showNotification = (config: Omit<NotificationModalType, 'isOpen'>) => {
    setNotificationModal({ ...config, isOpen: true })
  }

  const hideNotification = () => {
    setNotificationModal(prev => ({ ...prev, isOpen: false }))
  }

  const showImageModal = (src: string | null, alt: string) => {
    setImageModal({ isOpen: true, src: src || '', alt })
  }

  const hideImageModal = () => {
    setImageModal(prev => ({ ...prev, isOpen: false }))
  }

  // Loading and error states
  if (authLoading || dataLoading) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Loading your dashboard...</p>
        </div>
      </div>
    )
  }

  if (authError || dataError) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-6">
          <div className="text-blue-500 mb-4">
            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">Something went wrong</h3>
          <p className="text-gray-600 dark:text-gray-400 mb-4">
            {authError || dataError}
          </p>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Try Again
          </button>
        </div>
      </div>
    )
  }

  if (!user || !profile) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-gray-600 dark:text-gray-400">Please sign in to continue</div>
        </div>
      </div>
    )
  }

  // Action handlers
  const handleApplyToProperty = async (details: {
    registration_number: string
    national_id: string
    bed_id: string
    gender: string
  }) => {
    try {
      const result = await submitApplication(
        details.registration_number,
        details.national_id,
        details.bed_id,
        details.gender
      )
      if (result.data) {
        showNotification({
          title: 'Application Submitted',
          message: 'Your application has been submitted successfully.',
          type: 'success'
        })
        refreshData()
      } else {
        throw new Error(result.error)
      }
    } catch (error) {
      showNotification({
        title: 'Application Failed',
        message: error instanceof Error ? error.message : 'Failed to submit application',
        type: 'error'
      })
    }
  }

  const handleCancelApplication = async (applicationId: string) => {
    showConfirmation({
      title: 'Cancel Application',
      message: 'Are you sure you want to cancel this application? This action cannot be undone.',
      onConfirm: async () => {
        try {
          const result = await cancelApplication(applicationId)
          if (result.data) {
            showNotification({
              title: 'Application Cancelled',
              message: 'Your application has been cancelled.',
              type: 'success'
            })
            refreshData()
          } else {
            throw new Error(result.error)
          }
        } catch (error) {
          showNotification({
            title: 'Error',
            message: error instanceof Error ? error.message : 'Failed to cancel application',
            type: 'error'
          })
        }
        hideConfirmation()
      }
    })
  }

  const handleSaveProperty = async (propertyId: string) => {
    try {
      const { error } = await supabase
        .from('saved_properties')
        .insert({ bed_id: propertyId, user_id: user.id })
      
      if (error) throw error
      
      showNotification({
        title: 'Property Saved',
        message: 'Property has been added to your saved list.',
        type: 'success'
      })
      refreshData()
    } catch (error) {
      showNotification({
        title: 'Error',
        message: 'Failed to save property',
        type: 'error'
      })
    }
  }

  const handleUnsaveProperty = async (propertyId: string) => {
    try {
      const { error } = await supabase
        .from('saved_properties')
        .delete()
        .eq('bed_id', propertyId)
        .eq('user_id', user.id)
      
      if (error) throw error
      
      showNotification({
        title: 'Property Removed',
        message: 'Property has been removed from your saved list.',
        type: 'success'
      })
      refreshData()
    } catch (error) {
      showNotification({
        title: 'Error',
        message: 'Failed to remove property',
        type: 'error'
      })
    }
  }

  // Render content based on active tab
  const renderContent = () => {
    const contentClasses = "p-6 lg:p-8"
    
    switch (activeTab) {
      case 'overview':
        return (
          <div className={contentClasses}>
            <DashboardOverview
              profile={profile}
              properties={properties}
              agentApplications={agentApplications}
              tenantApplications={applications}
              savedProperties={savedProperties}
              setActiveTab={setActiveTab}
              onBrowseProperties={() => setActiveTab('browse')}
            />
          </div>
        )
      
      case 'browse':
        return (
          <div className={contentClasses}>
            <PropertiesBrowser
              allProperties={allProperties}
              applications={applications}
              savedProperties={savedProperties}
              profile={profile}
              onApplyToProperty={(propertyId: string) => {
                setApplicationModal({ isOpen: true, bedId: propertyId })
              }}
              onCancelApplication={handleCancelApplication}
              onSaveProperty={handleSaveProperty}
              onUnsaveProperty={handleUnsaveProperty}
              onImageClick={showImageModal}
            />
          </div>
        )
      
      case 'properties':
        return (
          <div className={contentClasses}>
            <AgentProperties
              properties={properties}
              onImageClick={showImageModal}
            />
          </div>
        )
      
      case 'applications':
        return (
          <div className={contentClasses}>
            <DashboardApplications
              applications={applications}
              agentApplications={agentApplications}
              profile={profile}
              onApproveApplication={async (applicationId: string) => {
                try {
                  const result = await updateApplicationStatus(applicationId, 'approved')
                  if (result.data) {
                    showNotification({
                      title: 'Application Approved',
                      message: 'Application approved successfully.',
                      type: 'success'
                    })
                    refreshData()
                  } else {
                    throw new Error(result.error)
                  }
                } catch (error) {
                  showNotification({
                    title: 'Error',
                    message: error instanceof Error ? error.message : 'Failed to approve application',
                    type: 'error'
                  })
                }
              }}
              onRejectApplication={async (applicationId: string) => {
                try {
                  const result = await updateApplicationStatus(applicationId, 'rejected')
                  if (result.data) {
                    showNotification({
                      title: 'Application Rejected',
                      message: 'Application rejected successfully.',
                      type: 'success'
                    })
                    refreshData()
                  } else {
                    throw new Error(result.error)
                  }
                } catch (error) {
                  showNotification({
                    title: 'Error',
                    message: error instanceof Error ? error.message : 'Failed to reject application',
                    type: 'error'
                  })
                }
              }}
              onVerifyPayment={async (applicationId: string) => {
                try {
                  const result = await verifyPayment(applicationId)
                  if (result.data) {
                    showNotification({
                      title: 'Payment Verified',
                      message: 'Payment verified successfully.',
                      type: 'success'
                    })
                    refreshData()
                  } else {
                    throw new Error(result.error)
                  }
                } catch (error) {
                  showNotification({
                    title: 'Error',
                    message: error instanceof Error ? error.message : 'Failed to verify payment',
                    type: 'error'
                  })
                }
              }}
            />
          </div>
        )
      
      case 'saved':
        return (
          <div className={contentClasses}>
            <SavedProperties
              savedProperties={savedProperties}
              applications={applications}
              onApplyToProperty={(propertyId: string) => {
                setApplicationModal({ isOpen: true, bedId: propertyId })
              }}
              onCancelApplication={handleCancelApplication}
              onUnsaveProperty={handleUnsaveProperty}
              onImageClick={showImageModal}
              setActiveTab={setActiveTab}
            />
          </div>
        )
      
      case 'commission':
        return (
          <div className={contentClasses}>
            <CommissionTracking
              agentApplications={agentApplications}
            />
          </div>
        )
      
      case 'account':
        return (
          <div className={contentClasses}>
            <DashboardAccount
              user={user}
              profile={profile}
              onSignOut={handleSignOut}
              onUpdateEcocash={async (ecocashNumber: string) => {
                try {
                  const { error } = await supabase
                    .from('profiles')
                    .update({ ecocash_number: ecocashNumber })
                    .eq('id', user.id)
                  
                  if (error) throw error
                  
                  showNotification({
                    title: 'Profile Updated',
                    message: 'EcoCash number updated successfully.',
                    type: 'success'
                  })
                  refreshData()
                } catch (error) {
                  showNotification({
                    title: 'Error',
                    message: 'Failed to update EcoCash number',
                    type: 'error'
                  })
                }
              }}
            />
          </div>
        )
      
      default:
        return (
          <div className={contentClasses}>
            <div className="text-center py-12">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                Page not found
              </h3>
              <p className="text-gray-600 dark:text-gray-400 mt-2">
                The requested page could not be found.
              </p>
            </div>
          </div>
        )
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
      {/* Main Content Area */}
      <div className="w-full">
        {/* Top Header with Mobile Menu */}
        <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 sm:px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <HomeIcon className="w-8 h-8 text-blue-600 mr-3" />
              <div>
                {/* Tab Selection Dropdown */}
                <div className="relative">
                  <select
                    value={activeTab}
                    onChange={(e) => setActiveTab(e.target.value as DashboardTab)}
                    className="block w-36 py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                  >
                    {visibleNavigation ? visibleNavigation.map((item) => (
                      <option key={item.id} value={item.id}>
                        {item.label}
                      </option>
                    )) : null}
                  </select>
                </div>
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              {/* Notifications */}
              <button className="relative p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <BellIcon className="w-6 h-6" />
                {pendingApplicationsCount > 0 && (
                  <span className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center">
                    {pendingApplicationsCount > 9 ? '9+' : pendingApplicationsCount}
                  </span>
                )}
              </button>
              
              {/* User Menu */}
              <div className="flex items-center">
                <span className="text-sm text-gray-700 dark:text-gray-300 mr-2">
                  {displayName}
                </span>
                <button
                  onClick={handleSignOut}
                  className="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300"
                >
                  Sign Out
                </button>
              </div>
            </div>
          </div>
        </header>

        {/* Desktop Sidebar - Hidden on Mobile */}
        <div className="hidden lg:block lg:fixed lg:inset-y-0 lg:left-0 lg:z-50 lg:w-72 lg:overflow-y-auto lg:bg-white lg:dark:bg-gray-900 lg:border-r lg:border-gray-200 lg:dark:border-gray-700 lg:pb-32 lg:pt-16">
          <div className="px-4 py-6">
            {/* User Profile Section */}
            <div className="pb-6 mb-6 border-b border-gray-200 dark:border-gray-700">
              <div className="flex items-center">
                <div className="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                  <UserCircleIconSolid className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                </div>
                <div className="ml-3">
                  <p className="text-sm font-medium text-gray-900 dark:text-white">
                    {profile?.full_name || 'User'}
                  </p>
                  <p className="text-xs text-gray-500 dark:text-gray-400 capitalize">
                    {profile?.role}
                  </p>
                </div>
              </div>
            </div>

            {/* Desktop Navigation */}
            <nav className="space-y-2">
              {visibleNavigation.map((item) => {
                const Icon = activeTab === item.id ? item.iconSolid : item.icon
                const isActive = activeTab === item.id
                
                return (
                  <button
                    key={item.id}
                    onClick={() => handleTabChange(item.id)}
                    className={`
                      w-full flex items-center px-3 py-3 text-sm font-medium rounded-lg transition-colors duration-200 group
                      ${isActive
                        ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800'
                        : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white'
                      }
                      ${item.isPrimary ? 'ring-2 ring-blue-100 dark:ring-blue-900/30' : ''}
                    `}
                  >
                    <Icon className={`w-5 h-5 mr-3 ${isActive ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 group-hover:text-gray-500 dark:group-hover:text-gray-300'}`} />
                    <span className="flex-1 text-left">{item.label}</span>
                    
                    {/* Badge for unread counts */}
                    {item.badge && item.badge > 0 && (
                      <span suppressHydrationWarning className="ml-2 px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full">
                        {item.badge > 99 ? '99+' : item.badge}
                      </span>
                    )}

                    {/* Primary indicator */}
                    {item.isPrimary && (
                      <div className="ml-2 w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full"></div>
                    )}
                  </button>
                )
              })}
            </nav>

            {/* Footer */}
            <div className="pt-6 mt-6 border-t border-gray-200 dark:border-gray-700">
              <div className="text-xs text-gray-500 dark:text-gray-400 text-center">
                © 2025 UniStay Platform
              </div>
            </div>
          </div>
        </div>

        {/* Page Title (Below Header) */}
        <div className="bg-gray-50 dark:bg-gray-900 px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          {activeTab === 'overview' ? (
            <div>
              <h1 className="text-2xl font-bold text-gray-900 dark:text-white">
                Welcome back, {profile?.full_name || (profile?.role === 'agent' ? 'Agent' : 'Student')}!
              </h1>
              <p className="text-gray-600 dark:text-gray-400 mt-1">
                {profile?.role === 'agent' 
                  ? 'Manage your property portfolio and client relationships'
                  : 'Find your perfect accommodation'
                }
              </p>
            </div>
          ) : (
            <h1 className="text-2xl font-bold text-gray-900 dark:text-white">
              {activeTab === 'browse' && 'Search & Browse Properties'}
              {activeTab === 'properties' && 'Property Management'}
              {activeTab === 'applications' && (profile?.role === 'agent' ? 'Application Reviews' : 'My Applications')}
              {activeTab === 'saved' && 'Saved Properties'}
              {activeTab === 'commission' && 'Commission Tracking'}
              {activeTab === 'account' && 'Profile & Settings'}
            </h1>
          )}
        </div>

        {/* Main Content */}
        <main className="px-4 sm:px-6 lg:px-8 lg:pl-80 py-6 pb-20">
          {renderContent()}
        </main>
      </div>

      {/* Modals */}
      <ConfirmationModal
        isOpen={confirmationModal.isOpen}
        onClose={hideConfirmation}
        onConfirm={confirmationModal.onConfirm}
        title={confirmationModal.title}
        message={confirmationModal.message}
      />

      <NotificationModal
        isOpen={notificationModal.isOpen}
        onClose={hideNotification}
        title={notificationModal.title}
        message={notificationModal.message}
        type={notificationModal.type}
      />

      <ImageModal
        isOpen={imageModal.isOpen}
        onClose={hideImageModal}
        src={imageModal.src}
        alt={imageModal.alt}
      />

      <ApplicationModal
        isOpen={applicationModal.isOpen}
        onClose={() => setApplicationModal({ isOpen: false, bedId: null })}
        beds={availableBeds}
        onSubmit={handleApplyToProperty}
      />

      <ToastManager />
    </div>

      {/* Modals */}
      <ConfirmationModal
        isOpen={confirmationModal.isOpen}
        onClose={hideConfirmation}
        onConfirm={confirmationModal.onConfirm}
        title={confirmationModal.title}
        message={confirmationModal.message}
      />

      <NotificationModal
        isOpen={notificationModal.isOpen}
        onClose={hideNotification}
        title={notificationModal.title}
        message={notificationModal.message}
        type={notificationModal.type}
      />

      <ImageModal
        isOpen={imageModal.isOpen}
        onClose={hideImageModal}
        src={imageModal.src}
        alt={imageModal.alt}
      />

      <ApplicationModal
        isOpen={applicationModal.isOpen}
        onClose={() => setApplicationModal({ isOpen: false, bedId: null })}
        beds={availableBeds}
        onSubmit={handleApplyToProperty}
      />

      <ToastManager />
    </div>
  )
}
